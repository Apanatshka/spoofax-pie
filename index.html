


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.1.6">
    
    
      
        <title>Spoofax 3</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.4b9ffd7b.min.css">
      
        <link rel="stylesheet" href="assets/stylesheets/palette.b79bcd20.min.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="." title="Spoofax 3" class="md-header-nav__button md-logo" aria-label="Spoofax 3">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Spoofax 3
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Introduction
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/metaborg/spoofax-pie/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    metaborg/spoofax-pie
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Spoofax 3" class="md-nav__button md-logo" aria-label="Spoofax 3">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Spoofax 3
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/metaborg/spoofax-pie/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    metaborg/spoofax-pie
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Introduction
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="." title="Introduction" class="md-nav__link md-nav__link--active">
      Introduction
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    Motivation
  </a>
  
    <nav class="md-nav" aria-label="Motivation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#language-loading" class="md-nav__link">
    Language loading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-tracing" class="md-nav__link">
    Error tracing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-of-problems" class="md-nav__link">
    Summary of Problems
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-ideas" class="md-nav__link">
    Key ideas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-status" class="md-nav__link">
    Current Status
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anatomy-of-a-spoofax-3-language-implementation" class="md-nav__link">
    Anatomy of a Spoofax 3 language implementation
  </a>
  
    <nav class="md-nav" aria-label="Anatomy of a Spoofax 3 language implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#language-project" class="md-nav__link">
    Language Project
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spoofax-3-architecture-overview" class="md-nav__link">
    Spoofax 3 architecture overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adapter-project" class="md-nav__link">
    Adapter Project
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform-projects" class="md-nav__link">
    Platform Projects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developing-language-implementations" class="md-nav__link">
    Developing Language Implementations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    Motivation
  </a>
  
    <nav class="md-nav" aria-label="Motivation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#language-loading" class="md-nav__link">
    Language loading
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-tracing" class="md-nav__link">
    Error tracing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-of-problems" class="md-nav__link">
    Summary of Problems
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-ideas" class="md-nav__link">
    Key ideas
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-status" class="md-nav__link">
    Current Status
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anatomy-of-a-spoofax-3-language-implementation" class="md-nav__link">
    Anatomy of a Spoofax 3 language implementation
  </a>
  
    <nav class="md-nav" aria-label="Anatomy of a Spoofax 3 language implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#language-project" class="md-nav__link">
    Language Project
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spoofax-3-architecture-overview" class="md-nav__link">
    Spoofax 3 architecture overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adapter-project" class="md-nav__link">
    Adapter Project
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#platform-projects" class="md-nav__link">
    Platform Projects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#developing-language-implementations" class="md-nav__link">
    Developing Language Implementations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/metaborg/spoofax-pie/edit/master/docs/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h1>
<p>Spoofax 3 is a <em>modular</em> and <em>incremental</em> textual language workbench running on the JVM: a collection of tools and Java libraries that enable the development of textual languages, embeddable into batch compilers, code editors and IDEs, or custom applications.
It is a reimplementation of <a href="http://spoofax.org">Spoofax 2</a>, with the goal of being more modular, flexible, and correctly incremental.</p>
<p>Currently, Spoofax 3 is experimental and still a work-in-progress.
Therefore, it does not have a stable API, lacks documentation and test coverage, and has not yet been applied to real-world use cases.
If you are looking for a more mature alternative, see <a href="http://spoofax.org">Spoofax 2</a>, which Spoofax 3 is based on.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">&para;</a></h2>
<p>We first discuss the motivations for developing Spoofax 3.</p>
<h3 id="architecture">Architecture<a class="headerlink" href="#architecture" title="Permanent link">&para;</a></h3>
<p>The main motivation for developing Spoofax 3 is the monolithic, inflexible, and non-incremental architecture of Spoofax 2:</p>
<ul>
<li>
<p>It has an <em>inflexible fixed-function pipeline</em>, where every file of your language is parsed, analyzed, and transformed.
  This works fine, and can even be incremental when the files of your language can be separately compiled.
  However, this is often not the case.
  Languages should be able to define their own incremental pipelines with minimal effort.
  Those pipelines should be modular and flexible, enabling usage in a wide range applications such as command-line interfaces, build systems, code editors, and IDEs.</p>
</li>
<li>
<p>It is monolithic for <em>language users</em> (i.e., the users of your programming language that you have developed with Spoofax), as every language developed with Spoofax 2 depends on Spoofax Core, which in turn depends on all meta-components: JSGLR1 and 2, NaBL+TS index and task engine, NaBL2 &amp; Statix solver, dynsem interpreter, Stratego runtime, config parsing libraries, etc.
  A language should only require the meta-components that it uses.</p>
</li>
<li>
<p>It is monolithic for <em>meta-component developers</em> (e.g., the developers of the language workbench, or researchers experimenting with new meta-tools or meta-languages).
  New meta-components need to be tightly integrated into Spoofax Core, requiring time-consuming changes and introducing increased coupling.
  We should develop meta-components in separation, and loosely couple/integrate them (as much as possible).</p>
</li>
<li>
<p>The <em>build of Spoofax 2</em> itself is monolithic and non-incremental, as all its components are compiled in one huge non-incremental build, massively increasing iteration time during development.
  The build must be incremental, and components should be separated where possible to reduce coupling, decreasing iteration times.</p>
</li>
</ul>
<h3 id="language-loading">Language loading<a class="headerlink" href="#language-loading" title="Permanent link">&para;</a></h3>
<p>Furthermore, Spoofax 2 <em>only support dynamic loading of languages</em>, where a language can be (re)loaded into the running environment.
This is very useful during language development, as it enables fast prototyping.
However, when we want to statically load the language, we still need to perform the dynamic loading ritual: somehow include the language archive in your application, and then load it at runtime.
This hurts startup time, is not supported on some platforms (e.g., Graal native image), and is tedious.
We should support both static and dynamic loading (where possible).</p>
<h3 id="error-tracing">Error tracing<a class="headerlink" href="#error-tracing" title="Permanent link">&para;</a></h3>
<p>Some errors are not being traced back to their source.
For example, many errors in configuration only show up during build time (in the console, which may be hidden) and are not traced back to the configuration file.
This confuses users, and may get stuck on simple things, which then require help from us.
Errors, warnings, and informational messages should be traced back to their source, and shown inline at the source in IDE environments, or shown as a list of messages with origin information on the command-line.
When there are errors, execution should continue in certain instances (e.g., parse error should recover and try to do analysis), but should not in others (e.g., error from static analysis should prevent execution since it could crash).</p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<p>Another issue is the scattered configuration in language specifications, which is spread over many different places:</p>
<ul>
<li><code>metaborg.yaml</code></li>
<li><code>editor/*.esv</code></li>
<li><code>dynsem.properties</code></li>
<li>In meta-languages files. For example, template options in SDF3.</li>
<li><code>pom.xml</code></li>
<li><code>.mvn/extensions.xml</code></li>
</ul>
<p>Finding the right configuration option in these files, and keeping them in sync, is tedious.
Furthermore, while most configuration is documented on our website, looking that up still causes a cognitive gap.
We should consolidate configuration that belongs together, and not have any duplicate configuration that needs to be kept in sync.
Configuration should be supported with editor services such as inline errors and code completion, if possible.</p>
<p>Moreover, some parts of a language specification are configured by convention, and these conventions cannot be changed.
For example, the main SDF3 file is always assumed to be <code>syntax/&lt;language-name&gt;.sdf3</code>.
When the language name is changed, but we forget to change the name of this main file, no parse table is built.
Configuration conventions should be changeable, and defaults should be persisted to ensure that renamings do not break things.</p>
<h3 id="summary-of-problems">Summary of Problems<a class="headerlink" href="#summary-of-problems" title="Permanent link">&para;</a></h3>
<p>To summarize, Spoofax 2 suffers from the following problems that form the motivation for Spoofax 3:</p>
<ul>
<li>Monolithic, inflexible, and non-incremental architecture causing:<ul>
<li>Inflexible and slow language processing due to non-incremental fixed-function pipeline</li>
<li>Coupling in Spoofax Core: every language depends on Spoofax Core, and Spoofax Core depends on all meta-components</li>
<li>Slow iteration times when developing Spoofax 2 due to its monolithic and non-incremental build</li>
<li>Tedious to use languages due to dynamic language loading</li>
</ul>
</li>
<li>Confusing (end-)user experience due to:<ul>
<li>Bad error traceability</li>
<li>Scattered configuration</li>
<li>Non-incremental configuration (restarts required to update configuration)</li>
</ul>
</li>
</ul>
<h2 id="key-ideas">Key ideas<a class="headerlink" href="#key-ideas" title="Permanent link">&para;</a></h2>
<p>To solve these problems, we intend to employ the following key ideas in Spoofax 3.</p>
<p>To reduce coupling, Spoofax 3's "Spoofax Core" does not depend on any meta-components.
Instead, a language implementation depends directly on the meta-components that it requires.
For example, the Tiger language implementation depends directly on the JSGLR2 parser, the NaBL2 constraint solver, and the Stratego runtime.</p>
<p>To make language pipelines flexible, modular, and incremental, we use an incremental, modular, and expressive build system as the basis for creating pipelines: <a href="https://github.com/metaborg/pie">PIE</a>.
Language processing steps such as parsing, styling text, analyzing, checking (to provide inline error messages), running (parts of) a compiler, etc. become PIE task definitions.
Tasks, which are instances of these task definitions, can depend on each other, and depend on resources such as files.
The PIE runtime efficiently and incrementally executes tasks.
Furthermore, task definitions can be shared and used by other language implementations, making language implementations modular.</p>
<p>To reduce the tedium of dynamic language loading, we instead choose to do static language loading as the default.
A language implementation is just a JAR file that can be put on the classpath and used as a regular Java library.
For example, to use the JSGLR2 parser of the Tiger language, we just depend on the Tiger language implementation as we would depend on a regular Java library, create an instance of the <code>TigerParser</code> class, and then use that to parse a string into an AST.</p>
<p>We still want to automatically provide integrations with the command-line, build systems such as Gradle, and IDEs such as Eclipse and IntelliJ.
Therefore, every language implementation must implement the <code>LanguageInstance</code> interface.
Spoofax 3 then provides libraries which take a <code>LanguageInstance</code> object, and integrate it with a platform.
For example, <code>spoofax.cli</code> takes a <code>LanguageInstance</code> object and provides a command-line application, and <code>spoofax.eclipse</code> does the same for an Eclipse plugin.</p>
<p>Because language implementations are just regular Java libraries, they now require some Java boilerplate.
However, we do not want language developers to write this Java boilerplate for standard cases.
Therefore, we employ a Spoofax 3 compiler that generates this Java boilerplate.
If the language developer is not happy with the implementation, or wants to customize parts, they can manually implement or extend Java classes where needed.
It is also possible to not use the Spoofax 3 compiler at all, and manually implement all parts.</p>
<p>To enable quick language prototyping, we still support dynamic language loading in environments that support them (e.g., Eclipse and IntelliJ), by dynamically loading the language implementation JAR when changed.
For example, when prototyping the Tiger language in Eclipse, if the syntax definition is changed we run the Spoofax 3 compiler to (incrementally) create a new parse table and Java classes, and dynamically (re)load the JAR.</p>
<p>To improve the user experience, we use a configuration DSL to configure language specifications and implementations.
Thereby configuration is centralized, has domain-specific checking, and editor services such as inline errors and code completion.
We also allow changing of defaults (conventions), and persist them to enable renaming.</p>
<p>To improve error traceability, errors are reported inline where possible.
Errors are traced through PIE pipelines and support origin tracking to easily support error traceability and inline errors for all language implementations.</p>
<p>TODO: better builders:
non-Stratego commands
incremental commands
separate commands from how they are executed
support command parameters/arguments
continuous execution</p>
<p>TODO: modular and incremental development of Spoofax 3 itself with Gradle</p>
<h2 id="current-status">Current Status<a class="headerlink" href="#current-status" title="Permanent link">&para;</a></h2>
<p>We have stated our key ideas, but since Spoofax 3 is still under heavy development, they have not all been implemented yet.
We now discuss the current status of Spoofax 3 by summarizing the key ideas and whether they has been implemented, along with any comments.</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Decoupling</strong>: Spoofax Core not depend on any meta-components. Language implementations instead depend on the meta-components they require.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Flexible, modular and incremental pipelines</strong>: Use <a href="https://github.com/metaborg/pie">PIE</a>.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Static loading</strong>: Use static loading by default, making language implementation plain JAR files, which are easy to use in the Java ecosystem.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong><code>LanguageInstance</code> interface</strong>: Language implementations must implement the <code>LanguageInstance</code> interface, which a platform library uses to integrate a language with the platform.<ul>
<li>An initial version of the <code>LanguageInstance</code> interface exists, but this interface is not yet stable and will receive many new features.</li>
<li>Currently, this interface contains features pertaining both command-line platforms and IDE/code editor platforms. These may be split up in the future.</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Generate Java boilerplate</strong>: Generate the Java boilerplate that Spoofax 3 now requires due to the <code>LanguageInstance</code> interface and language implementations being plain JAR files.<ul>
<li>Configuration for the Spoofax 3 compiler is provided through a Gradle build script, which is verbose.</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <strong>Quick language prototyping</strong>: Support dynamic language loading in environments that support this, to enable quick language prototyping.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <strong>Configuration DSL</strong>: Use a configuration DSL to improve the developer/user experience.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> <strong>Error origin tracking</strong>: Perform origin tracking and propagation on errors to improve the developer/user experience.<ul>
<li>Errors are traced through most PIE tasks, but do not always contain specific origin information</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Commands</strong>: More flexible and incremental version of "builders" from Spoofax 2.<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Non-Stratego commands</strong>: Commands execute PIE tasks, which execute Java code.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Incremental commands</strong>: Commands are incremental because they execute PIE tasks.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Separate commands from how they are executed</strong>: Commands can be bound to IDE/editor menus, command-line commands, or to resource changes.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Command parameters/arguments</strong>: Commands can specify parameters, which must be provided as arguments when executed.</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> <strong>Modular and incremental development</strong>: Use Gradle (instead of Maven) to build Spoofax 3, which increases modularity and provides incremental builds for faster iteration times.</li>
</ul>
<p>Furthermore, we now discuss the status of features that were not new key ideas.</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Language builds<ul>
<li>We have an initial version of a Spoofax 3 compiler which is completely based on Spoofax 3 and PIE (independent from Spoofax 2), but it is still unstable.</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Meta-language bootstrapping<ul>
<li>Bootstrapping requires implementation of the meta-languages in Spoofax 3, which we have not done yet.</li>
</ul>
</li>
<li>Meta-tools<ul>
<li>Syntax specification<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> SDF3</li>
</ul>
</li>
<li>Parsing<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> JSGLR1</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> JSGLR2<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Incremental parsing</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> New water rules</li>
</ul>
</li>
<li>Styling specification<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> ESV (syntax-based)</li>
</ul>
</li>
<li>Semantic analysis<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> NaBL2</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Statix</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Statix signature generation based on SDF3 specification</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> FlowSpec</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Stratego</li>
</ul>
</li>
<li>Transformation (compilation)<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Stratego</li>
</ul>
</li>
</ul>
</li>
<li>Editor services<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Syntax-based styling</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Inline error/warning/note messages</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Code completion</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Outline</li>
</ul>
</li>
<li>Platforms<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Command-line</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Eclipse<ul>
<li>An Eclipse plugin for your language is provided, but it not yet mature</li>
<li>Concurrency/parallelism is completely ignored. Therefore, things may run concurrently that are not suppose to which cause data races and crashes.</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> IntelliJ<ul>
<li>A very minimal IntelliJ plugin for your language is provided, currently only supporting syntax highlighting and inline parse errors.</li>
</ul>
</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Gradle</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> Maven</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> REPL</li>
</ul>
</li>
</ul>
<p>The following features are being prototyped/experimented with Spoofax 3:</p>
<ul>
<li>Multi-lingual semantic analysis with Statix (Aron Zwaan)</li>
<li>Semantic code completion based on Statix specification (Daniel Pelsmaeker)</li>
</ul>
<p>The following features will most likely not be supported:</p>
<ul>
<li>Analysis with NaBL/TS</li>
</ul>
<h2 id="anatomy-of-a-spoofax-3-language-implementation">Anatomy of a Spoofax 3 language implementation<a class="headerlink" href="#anatomy-of-a-spoofax-3-language-implementation" title="Permanent link">&para;</a></h2>
<p>In this subsection, we give a high-level overview of what a Spoofax 3 language implementation is, dive into details, and explain how such a implementation can be manually written or completely generated from a high-level language specification</p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>In essence, a language implementation in Spoofax 3 is nothing more than a standard Java library (e.g., a JAR file) with Java classes implementing or delegating to the various functionalities of the language such as parsing and transformations, as well as bundled resources such as a parse table which is loaded and interpreted at runtime.</p>
<p>Therefore, Spoofax 3 language implementations are very easy to use in the Java ecosystem by just distributing the JAR file of the language, or by publishing/consuming it as a library with a build system such as Gradle.
Furthermore, since no classloading or class generation is used, GraalVM native image can be used to ahead-of-time compile your language implementation into native code which does not require a JVM at all, and significantly reduces the startup time of your language.</p>
<p>Diving deeper, a language implementation is actually split into three parts: a <strong>language project</strong> that contains the base functionality of the language, an <strong>adapter project</strong> that adapts the language project to the interface of Spoofax, and <strong>platform projects</strong> that plug the adapter project into various other platforms such as a command-line interface (CLI) and Eclipse plugin (TODO: more details on supported platforms in a separate section).
We will first explain these projects and why this separation was chosen.</p>
<p>TODO: diagram?</p>
<h3 id="language-project">Language Project<a class="headerlink" href="#language-project" title="Permanent link">&para;</a></h3>
<p>A language project contains the <em>base functionality</em> of a language, such as a parser, syntax highlighter, analyzer, and compiler for the language.
Such a project is <em>unstructured</em>: it does not have to adhere to any interface or data format. Therefore, it may use any tooling, libraries, and data structures to implement the base functionality.
This facilitates integration of existing tools and minimal dependencies.</p>
<p>A language project is just a Java library and can thus be used in a standalone fashion.
However, there is no glue between base functionality, requiring manual implementation of a parse-analyze-compile pipeline for example.
Furthermore, because the project is unstructured, we cannot provide any integration with other platforms such as a CLI and Eclipse plugin.
Therefore, using a language project as a standalone library is a bit of a niche use case for when minimal dependencies or full control is absolutely necessary.
Because it is such a niche use case, the default in Spoofax 3 is to merge it together with the adapter project.</p>
<p>In essence, an adapter project adapts a language project to Spoofax 3.
To understand why, we first explain the high-level architecture of Spoofax 3.</p>
<h3 id="spoofax-3-architecture-overview">Spoofax 3 architecture overview<a class="headerlink" href="#spoofax-3-architecture-overview" title="Permanent link">&para;</a></h3>
<p>Spoofax 3 provides a general interface for language implementations: <code>LanguageInstance</code>, which is used by platforms to automatically plug languages into their platform.
For example, <code>LanguageInstance</code> has functionality for <em>syntax highlighting</em>, which when given a resource of the language, returns a syntax highlighting for that resource.
(TODO: more details on the functionality in <code>LanguageInstance</code> in a separate section)</p>
<p>Furthermore, Spoofax 3 uses <a href="https://github.com/metaborg/pie">PIE</a>; a framework for building incremental pipelines, build systems, and compilers; to incrementalize the language implementation.
Instead of directly computing the syntax highlighting for a resource, we create a <em>task</em> that returns the syntax highlighting when demanded, with PIE taking care of whether it should recompute the syntax highlighting because the resource (or the syntax highlighting implementation) changed, or if it can just be returned from a cache.
(TODO: more details on PIE in a separate section)</p>
<p>A platform such as Eclipse or IntelliJ can then take a <code>LanguageInstance</code> implementation, demand the syntax highlighting task, and show the result it in the editor for your language.
Therefore, any language that implements <code>LanguageInstance</code> can get syntax highlighting in Eclipse, IntelliJ, and any other supported platforms for free, with PIE taking care of coarse-grained incrementalization.</p>
<p>To receive the benefits of Spoofax 3, the adapter project must thus be implemented for your language.</p>
<h3 id="adapter-project">Adapter Project<a class="headerlink" href="#adapter-project" title="Permanent link">&para;</a></h3>
<p>An adapter project implements Spoofax 3's <code>LanguageInstance</code> using the language project. This requires glue code between the unstructured language project and the <em>structured</em> <code>LanguageInstance</code> interface.
For example, you would need to convert the data structure that the syntax highlighter of your language returns, to one that Spoofax 3 understands: the <code>Styling</code> class.
Furthermore, because Spoofax 3 uses PIE, we also need to implement a PIE <em>task definition</em> that implements the (re)computing of syntax highlighting, as well as mark all dependencies that should cause the syntax highlighting to be recomputed.</p>
<p>We also need to be able to instantiate your implementation of <code>LanguageInstance</code>.
In case this is non-trivial, the recommended practice is to use dependency injection to achieve proper separation of concerns.
A dependency injection framework such as <a href="https://dagger.dev/">Dagger</a> is recommended (we use it extensively in Spoofax 3) because it catches dependency injection errors at compile-time, and does not require runtime class loading or generation.</p>
<p>This may sound like you would need to write a lot of boilerplate.
However, we provide a compiler that generates all this boilerplate for you.
It is only necessary to write this boilerplate if you are integrating existing tooling.
Even then, the compiler can generate some of the boilerplate for you.
More details on the compiler can be found in the developing language implementations section.</p>
<h3 id="platform-projects">Platform Projects<a class="headerlink" href="#platform-projects" title="Permanent link">&para;</a></h3>
<p>TODO: every language-platform combination is a separate project to support ahead-of-time compilation, static loading, and customization of the platform project.
CLI: can be ahead-of-time compiled with GraalVM native image to create a native Windows/macOS/Linux CLI for your language
Eclipse/IntelliJ: statically loaded plugin that can be deployed with Eclipse/IntelliJ, and can be fully customized.</p>
<h3 id="developing-language-implementations">Developing Language Implementations<a class="headerlink" href="#developing-language-implementations" title="Permanent link">&para;</a></h3>
<p>So far we have talked about what a language implementation is, but not yet how one is developed, which we will dive into now.</p>
<p>Language implementations are by default fully generated from a high-level language specification using the Spoofax 3 compiler, thereby supporting iterative language development with low boilerplate. However, it is possible implement parts of or even the entire language/adapter project by hand, facilitating the integration of existing tools and languages.</p>
<p>TODO: dynamic loading</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/vendor.a0c4167b.min.js"></script>
      <script src="assets/javascripts/bundle.fb26dd1d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: ".",
          features: [],
          search: Object.assign({
            worker: "assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>